<!doctype html>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CoreBoard â€” Dashboard</title>
<link rel="stylesheet" href="styles.css"/>

<body style="font-family:Inter,system-ui;background:#0b0b0c;color:#fff">
  <!-- Nav -->
  <nav class="nav">
    <div class="container inner">
      <a class="brand" href="index.html"><span class="logo"></span><span>CoreBoard</span></a>
      <div style="display:flex;gap:10px">
        <button id="signout" class="btn">Sign out</button>
      </div>
    </div>
  </nav>

  <!-- Page -->
  <div class="container" style="max-width:1000px;padding:18px 20px 28px">
    <header style="display:flex;justify-content:space-between;align-items:flex-end;gap:16px;margin-bottom:14px;flex-wrap:wrap">
      <div>
        <h1 style="margin:0 0 6px;font-size:24px;line-height:1">Daily Board</h1>
        <!-- fixed height line to prevent layout shift -->
        <div style="height:18px;display:flex;align-items:center;gap:10px">
          <span id="saveStatus" class="tiny" style="color:#a0a3a7;">â€”</span>
          <span id="err" class="tiny" style="color:#ffb3b3;display:none"></span>
        </div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <label class="tiny" style="color:#a0a3a7">Date</label>
        <input id="date" type="date" class="input" style="width:auto"/>
        <button id="todayBtn" class="btn ghost">Today</button>
      </div>
    </header>

    <div class="grid cards-2">
      <section class="card">
        <div class="label">Todayâ€™s Focus</div>
        <input id="focus" class="input" placeholder="What is the ONE win today?"/>
      </section>

      <section class="card">
        <div class="label">Notes</div>
        <textarea id="notes" class="input" style="min-height:140px" placeholder="What moved the needle today?"></textarea>
      </section>

      <section class="card">
        <div class="label">Top 3 Tasks</div>
        <div class="list">
          <div class="row" style="display:flex;gap:8px;align-items:center">
            <input id="t0done" type="checkbox"/><input id="t0" class="input" placeholder="Task 1"/>
          </div>
          <div class="row" style="display:flex;gap:8px;align-items:center">
            <input id="t1done" type="checkbox"/><input id="t1" class="input" placeholder="Task 2"/>
          </div>
          <div class="row" style="display:flex;gap:8px;align-items:center">
            <input id="t2done" type="checkbox"/><input id="t2" class="input" placeholder="Task 3"/>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="label">KPIs (today)</div>
        <div class="grid" style="grid-template-columns:repeat(4,1fr)">
          <input id="rev"  class="input" type="number" placeholder="Revenue"/>
          <input id="vis"  class="input" type="number" placeholder="Visitors"/>
          <input id="subs" class="input" type="number" placeholder="Email subs"/>
          <input id="fol"  class="input" type="number" placeholder="Followers"/>
        </div>
      </section>
    </div>

    <div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;align-items:center">
      <button id="save" class="btn">Save</button>
      <span class="tiny" style="color:#a0a3a7">Auto-saves after 1s idle</span>
    </div>

    <section class="card" style="margin-top:18px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div class="label" style="margin:0">History (last 30 days)</div>
      </div>
      <div style="overflow:auto">
        <table style="width:100%;border-collapse:collapse">
          <thead><tr>
            <th style="text-align:left;padding:10px;color:#a0a3a7">Date</th>
            <th style="text-align:left;padding:10px;color:#a0a3a7">Focus</th>
            <th style="text-align:left;padding:10px;color:#a0a3a7">Rev</th>
            <th style="text-align:left;padding:10px;color:#a0a3a7">Visitors</th>
            <th style="text-align:left;padding:10px;color:#a0a3a7">Subs</th>
            <th style="text-align:left;padding:10px;color:#a0a3a7">Done</th>
            <th style="text-align:left;padding:10px;color:#a0a3a7">Open</th>
          </tr></thead>
          <tbody id="hist"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Non-shifting toast -->
  <div id="toast" style="position:fixed;right:16px;bottom:16px;display:none;background:#141416;border:1px solid var(--line);padding:10px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);font-size:14px"></div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

  // ðŸ”§ Set these
  const SUPABASE_URL  = 'https://xcsbogfddhvbyscjkjsi.supabase.co'
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhjc2JvZ2ZkZGh2YnlzY2pranNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNzUzMjksImV4cCI6MjA3MDg1MTMyOX0.HGX4G2zw0F_EwMRuYOx3SMnP9qxurLHiYBUOe-9FEVk'
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON)

  // ===== utils
  const $ = (s)=>document.querySelector(s)
  const status = (t)=> $('#saveStatus').textContent = t
  const showErr = (t)=> { const e=$('#err'); e.textContent=t; e.style.display = t?'inline':'none' }
  const isoToday = ()=>{ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10) }

  // ===== toast (no reflow)
  const toast = $('#toast'); let toastTimer
  function showToast(text, ms=1200){ toast.textContent=text; toast.style.display='block'; clearTimeout(toastTimer); toastTimer=setTimeout(()=>toast.style.display='none', ms) }

  // ===== Auth gate
  const { data:{ session } } = await supabase.auth.getSession()
  if (!session) { location.href='login.html'; throw new Error('no session') }

  // ===== refs
  const dateEl=$('#date'), focusEl=$('#focus'), notesEl=$('#notes')
  const t=[ $('#t0'),$('#t1'),$('#t2') ], td=[ $('#t0done'),$('#t1done'),$('#t2done') ]
  const revEl=$('#rev'), visEl=$('#vis'), subsEl=$('#subs'), folEl=$('#fol')
  const histBody=$('#hist')

  // ===== nav
  $('#signout').onclick = async ()=>{ await supabase.auth.signOut(); location.href='login.html' }
  $('#todayBtn').onclick = ()=> { dateEl.value = isoToday(); loadDay(dateEl.value) }

  // ===== state
  dateEl.value = isoToday()
  let saveAbort = null

  async function loadDay(d){
    showErr('')
    status('Loadingâ€¦')
    try {
      const { data, error } = await supabase.from('daily_entries')
        .select('id,d,focus,notes,tasks,kpis').eq('d', d).maybeSingle()
      if (error && error.code!=='PGRST116') throw error
      const e = data || { d, focus:'', notes:'', tasks:[{},{},{}], kpis:{} }
      focusEl.value = e.focus || ''
      notesEl.value = e.notes || ''
      t.forEach((el,i)=> el.value = (e.tasks?.[i]?.title ?? ''))
      td.forEach((el,i)=> el.checked = !!(e.tasks?.[i]?.done))
      revEl.value = e.kpis?.rev ?? ''
      visEl.value = e.kpis?.vis ?? ''
      subsEl.value = e.kpis?.subs ?? ''
      folEl.value = e.kpis?.fol ?? ''
      status('Loaded')
    } catch(err){
      console.error(err); showErr('Load failed'); status('Error')
    }
  }

  async function saveDay(){
    // cancel any in-flight save
    if (saveAbort){ saveAbort.abort() }
    saveAbort = new AbortController()
    status('Savingâ€¦'); showErr('')
    const d = dateEl.value
    const payload = {
      user_id: session.user.id,
      d,
      focus: focusEl.value || '',
      notes: notesEl.value || '',
      tasks: [0,1,2].map(i=>({ title: t[i].value || '', done: td[i].checked })),
      kpis: {
        rev: Number(revEl.value||0)||0,
        vis: Number(visEl.value||0)||0,
        subs: Number(subsEl.value||0)||0,
        fol: Number(folEl.value||0)||0
      }
    }
    try {
      const { error } = await supabase.from('daily_entries').upsert(payload, { onConflict:'user_id,d' })
      if (error) throw error
      status('Saved âœ…')
      showToast('Saved')
      loadHistory(false)
    } catch(err){
      if (err?.name === 'AbortError') return
      console.error(err); status('Error'); showErr('Save failed â€” check connection or RLS')
    } finally { saveAbort = null }
  }

  // ===== autosave (debounced)
  let timer; const triggerSave=()=>{ clearTimeout(timer); timer=setTimeout(saveDay, 900) }
  ;[focusEl,notesEl,revEl,visEl,subsEl,folEl,...t,...td].forEach(el=>{
    el.addEventListener(el.type==='checkbox'?'change':'input', triggerSave)
  })
  $('#save').onclick = saveDay
  dateEl.onchange = ()=> loadDay(dateEl.value)

  // ===== history
  async function loadHistory(){
    try{
      const { data } = await supabase.from('daily_entries')
        .select('id,d,focus,kpis,tasks').order('d',{ascending:false}).limit(30)
      histBody.innerHTML = (data||[]).map(row=>{
        const done = Array.isArray(row.tasks)? row.tasks.filter(t=>t?.done).length : 0
        const open = Array.isArray(row.tasks)? row.tasks.filter(t=>!t?.done && (t?.title||'').trim()).length : 0
        return `<tr style="border-top:1px solid #232327;cursor:pointer"
                  onclick="document.querySelector('#date').value='${row.d}'; window.__load('${row.d}')">
          <td style="padding:10px">${row.d}</td>
          <td style="padding:10px;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:320px">${row.focus||'â€”'}</td>
          <td style="padding:10px">${row.kpis?.rev ?? 0}</td>
          <td style="padding:10px">${row.kpis?.vis ?? 0}</td>
          <td style="padding:10px">${row.kpis?.subs ?? 0}</td>
          <td style="padding:10px">${done}</td>
          <td style="padding:10px">${open}</td>
        </tr>`
      }).join('')
    }catch(e){ console.error(e) }
  }
  window.__load = (d)=> loadDay(d)

  // ===== boot
  await loadDay(dateEl.value)
  await loadHistory()
</script>
</body>


